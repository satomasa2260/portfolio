<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>RSS詳細デバッグ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    .article-item { margin: 10px 0; padding: 10px; background: #f5f5f5; }
    .image-info { color: #666; font-size: 0.9em; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>RSS詳細デバッグ</h1>
  <button id="debug-btn">RSS詳細デバッグ開始</button>
  <div id="debug-result"></div>

  <script>
    async function debugRSS() {
      const resultDiv = document.getElementById('debug-result');
      resultDiv.innerHTML = '<p>デバッグ開始...</p>';
      
      try {
        console.log('=== RSS詳細デバッグ開始 ===');
        
        const rssUrl = 'https://note.com/satomasa_eth/rss';
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
        
        console.log('API URL:', apiUrl);
        resultDiv.innerHTML += `<p><strong>API URL:</strong> ${apiUrl}</p>`;
        
        const response = await fetch(apiUrl);
        console.log('Response status:', response.status);
        resultDiv.innerHTML += `<p><strong>Response Status:</strong> ${response.status}</p>`;
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('=== 完全なRSSデータ ===', data);
        
        if (data.status === 'ok' && data.items && data.items.length > 0) {
          resultDiv.innerHTML += `<p class="success"><strong>記事数:</strong> ${data.items.length}件</p>`;
          
          // 最初の3件の記事を詳細分析
          data.items.slice(0, 3).forEach((article, index) => {
            console.log(`=== 記事${index + 1}の詳細 ===`, article);
            
            const articleDiv = document.createElement('div');
            articleDiv.className = 'article-item';
            
            // 画像関連フィールドの詳細分析
            const imageFields = {
              'thumbnail': article.thumbnail,
              'image': article.image,
              'enclosure': article.enclosure,
              'media': article.media,
              'media:content': article['media:content'],
              'media:thumbnail': article['media:thumbnail']
            };
            
            let imageInfo = '<div class="image-info"><strong>画像フィールド分析:</strong><br>';
            Object.entries(imageFields).forEach(([field, value]) => {
              if (value) {
                imageInfo += `✓ ${field}: ${JSON.stringify(value)}<br>`;
              } else {
                imageInfo += `✗ ${field}: undefined<br>`;
              }
            });
            imageInfo += '</div>';
            
            articleDiv.innerHTML = `
              <h3>記事${index + 1}: ${article.title}</h3>
              <p><strong>リンク:</strong> <a href="${article.link}" target="_blank">${article.link}</a></p>
              ${imageInfo}
              <p><strong>説明:</strong> ${article.description ? article.description.substring(0, 100) + '...' : 'なし'}</p>
            `;
            
            resultDiv.appendChild(articleDiv);
          });
          
          // 画像URLのテスト
          resultDiv.innerHTML += '<h3>画像URLテスト</h3>';
          data.items.slice(0, 3).forEach((article, index) => {
            const testDiv = document.createElement('div');
            testDiv.className = 'article-item';
            
            let testImage = '';
            if (article.thumbnail) {
              testImage = `<img src="${article.thumbnail}" alt="thumbnail" style="max-width: 200px; max-height: 150px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><span style="display:none; color:red;">画像読み込み失敗</span>`;
            } else if (article.image) {
              testImage = `<img src="${article.image}" alt="image" style="max-width: 200px; max-height: 150px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><span style="display:none; color:red;">画像読み込み失敗</span>`;
            } else {
              testImage = '<span style="color:red;">画像フィールドなし</span>';
            }
            
            testDiv.innerHTML = `
              <h4>記事${index + 1}の画像テスト</h4>
              ${testImage}
            `;
            
            resultDiv.appendChild(testDiv);
          });
          
        } else {
          resultDiv.innerHTML += `<p class="error">RSSデータの取得に失敗</p>`;
          resultDiv.innerHTML += `<p>Status: ${data.status}</p>`;
          resultDiv.innerHTML += `<p>Items: ${data.items ? data.items.length : 'undefined'}</p>`;
        }
        
      } catch (error) {
        console.error('RSS詳細デバッグ失敗:', error);
        resultDiv.innerHTML += `<p class="error">エラー: ${error.message}</p>`;
      }
    }

    document.getElementById('debug-btn').addEventListener('click', debugRSS);
  </script>
</body>
</html>
